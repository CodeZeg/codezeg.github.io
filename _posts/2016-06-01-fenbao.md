---
layout: post
title: 分包优化
categories: Blog
description: 一个unity资源的处理方案
keywords: unity
---

## 目的

减小包大小，提高转化率

## 方案

### 目前问题

1. 完整包还是动态更新只能选择一次
2. 什么目录在强更后不会清除 什么目录在强更后会被清除

### 资源分类

1. 包内资源
2. 除包内资源的剩余资源
3. 启动游戏时必须的资源
4. 加载场景时必须的资源
5. 动态替换的非必须资源

### 新增目录结构与配置格式

#### 目录结构
修改 Resources 为 res_start
新增 res_complate
新增 res_scene
新增 res_dynamic

#### 文件结构
场景资源列表
动态资源列表

#### 配置修改
新增 ServerList 内 res_complate_version
新增 ServerList 内 res_scene_version
新增 ServerList 内 res_dynamic_version
修改 ServerList 内 ResourceVersion 为 res_start_version
新增 ServerList 内 res_complate_server
新增 ServerList 内 res_scene_server
新增 ServerList 内 res_dynamic_server
修改 ServerList 内 ResourceServer 为 res_start_server
新增 本地存储 内 完整资源版本号

### 流程思路

#### 总流程
1. 启动游戏
1. 强跟包
1. 完整补丁资源
1. 启动补丁资源
1. 场景资源列表
1. 动态资源列表
1. 执行下载
1. 场景补丁资源
1. 动态补丁资源

#### 启动游戏
1. 启动游戏
2. 拉取ServerList
3. 对比serverlist

#### 强跟包
    1. 如果app版本号被提高了
    2. 下载最新包并覆盖安装

    1. 如果app版本号没有被提高
    2. => 完整补丁资源

#### 完整补丁资源
(更新方式可选 1.一次性更新完整资源 2.动态更新)

    1. 没有配置更新方式
    2. 弹框让玩家配置更新方式

    1. 更新方式为：一次性更新完整资源
    2. 如果 本地的 `完整资源版本号` < 远端的 `完整资源版本号`
    3. 扔到下载管理器中
    4. 修改 本地的 `完整资源版本号`
    5. => 启动补丁资源

	1. 更新方式为：一次性更新完整资源
	2. 如果 本地的 `完整资源版本号` >= 远端的 `完整资源版本号`
	3. => 启动补丁资源

	1. 更新方式为：动态更新
	2. => 启动补丁资源

#### 启动补丁资源
	1. 如果 本地的 `启动资源版本号` < 远端的 `启动资源版本号`
	2. 逆序遍历远端的 `启动资源库` 
	3. 将 本地版本 到远端版本的 所有补丁资源加入下载管理器中
	(例如本地版本为1，远端版本为3， 则下载 `1-2` 和 `2-3` 的所有补丁包)
	4. => 场景资源列表

	1. 如果 本地的 `启动资源版本号` >= 远端的 `启动资源版本号`
	1. => 场景资源列表

#### 场景资源列表
	1. 如果 本地的 `场景资源版本号` < 远端的 `场景资源版本号`
	2. 将场景资源列表扔到下载管理器中
	3. 修改本地的 `场景资源版本号`

	1. 如果 本地的 `场景资源版本号` >= 远端的 `场景资源版本号`
	2. => 动态资源列表

#### 动态资源列表
	1. 如果 本地的 `动态资源版本号` < 远端的 `动态资源版本号`
	2. 将场景资源列表扔到下载管理器中
	3. 修改本地的 `动态资源版本号`

	1. 如果 本地的 `动态资源版本号` >= 远端的 `动态资源版本号`
	2. => 执行下载

#### 执行下载
	1. 检查下载管理器中未下载完成的资源
	2. 下载
	3. 正式进入游戏

#### 场景补丁资源
	1. 进入场景
	2. 如果本地没有该场景资源记录
	3. 加入资源下载管理器
	4. 记录该场景资源版本
	5. 侦听下载完成事件

	1. 进入场景
	2. 如果本地有该场景资源记录
	3. 对比场景资源列表 该 场景资源版本号
	4. 如果该场景不是最新的资源
	5. 加入资源下载管理器
	6. 记录该场景资源版本
	7. 侦听下载完成事件

	1. 进入场景
	2. 如果本地有该场景资源记录
	3. 对比场景资源列表 该 场景资源版本号
	4. 如果该场景已经是最新的资源
	5. 正式进入场景

	1. 下载该场景资源完成
	2. 正式进入场景

#### 动态补丁资源
	1. 加载某个资源
	2. 发现找不到该资源
	3. 使用该资源替代资源
	4. 加入下载管理器
	5. 记录该资源的的版本号
	6. 侦听资源下载完成

	1. 加载某个资源
	2. 找到了该资源
	3. 找不到该资源版本记录
	4. 使用替代资源
	5. 加入下载管理器
	6. 记录该资源的版本号
	7. 侦听资源下载完成

	1. 加载某个资源
	2. 找到了该资源
	3. 该资源版本号 < 动态资源列表中的该资源版本号
	4. 使用替代资源
	5. 加入下载管理器
	6. 记录该资源的版本号
	7. 侦听资源下载完成
	
	1. 加载某个资源
	2. 找到了该资源
	3. 该资源版本号 >= 动态资源列表中的该资源版本号
	4. 直接使用该资源
	
	1. 监听到资源下载完成
	2. 替换掉替代资源
